"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("matrix-js-sdk"),t=require("effector"),n=require("@42px/effector-extra"),o=require("@42px/custom-errors");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=r(e);const i=t.createDomain("matrix"),a=i.effect(),d=i.effect(),c=i.effect(),l=i.effect(),u=i.effect(),f=i.effect(),m=i.effect(),g=i.effect(),p=i.effect(),x=i.effect(),v=i.effect(),y=i.effect(),w=i.effect(),E=i.effect(),I=i.effect(),R=i.effect(),T=i.event(),h=n.batchEvents(T,500),C=i.event(),F=i.event(),M=i.event();let b,S;const P=[],W=()=>(b||(b=s.default.createClient(S),P.forEach((([e,t])=>{b.on(e,t)}))),b),_=e=>{P.push(...e)},A="m.room.message",N="m.room.redaction";function B(e,t){return{originalEventId:void 0!==t?t:e.getId(),content:e.getContent(),sender:e.sender,originServerTs:e.getDate(),edited:Boolean(e.replacingEventId()),redacted:e.isRedacted()}}function D(e){const t=e.getLiveTimeline().getEvents();let n=0;const o=W();for(let r=t.length-1;r>=0&&o&&r!==t.length-99;r--){const s=t[r];if(e.hasUserReadEvent(o.getUserId(),s.getId()))break;n+=1}const r=t.filter((e=>[A,N].includes(e.getType()))).reduce(j,[]),s=r.length?r[r.length-1]:void 0;return{roomId:e.roomId,name:e.name,summary:e.summary,unreadCount:n,lastMessage:s}}function j(e,t){return t.isRelation("m.replace")||t.isRedaction()||e.push(B(t)),e}const k=o.createCustomError("RoomNotFound"),q=o.createCustomError("TimelineWindowUndefined"),O=o.createCustomError("PaginationFail"),U=o.createCustomError("EventNotFound");function z(){return W().getRooms().map(D)}let G;t.forward({from:a.done.map((()=>({initialSyncLimit:20}))),to:l}),a.use((e=>W().login("m.login.password",e))),d.use((e=>W().login("m.login.token",e))),c.use((async()=>{const{store:e}=W();if(e)return e.startup()})),l.use((e=>W().startClient(e))),f.use((async t=>(await W().search(t)).search_categories.room_events.results.map((({result:t})=>B(new e.MatrixEvent(t)))))),m.use((e=>W().searchMessageText(e))),g.use((({roomId:e,content:t,txnId:n})=>W().sendMessage(e,t,n))),p.use((({roomId:e,eventId:t,body:n,txnId:o})=>W().sendMessage(e,{"m.new_content":{msgtype:"m.text",body:n},"m.relates_to":{rel_type:"m.replace",event_id:t},msgtype:"m.text",body:""},o))),x.use((async({roomId:e,eventId:t,reason:n})=>{const o=n?{reason:n}:void 0;return{eventId:(await W().redactEvent(e,t,void 0,o)).event_id}})),v.use((e=>{const t=W().getRoom(e);return t?t.timeline.filter((e=>[A,N].includes(e.getType()))).reduce(j,[]):[]})),_([["Room.timeline",(e,t,n,o,r)=>{const s=e.getType();s!==A&&s!==N||!n&&r.liveEvent&&T(function(e){const t={eventId:e.getId(),content:e.getContent(),originServerTs:e.getDate(),roomId:e.getRoomId(),sender:e.sender,type:e.getType(),redaction:e.isRedaction(),redacted:e.isRedacted(),editing:Boolean(e.isRelation())};return e.hasAssocation()&&(t.relatedEventId=e.getAssociatedId()),t}(e))}],["sync",(e,t)=>{if("PREPARED"!==e)if("SYNCING"!==e||"PREPARED"!==t)if("SYNCING"!==e||"SYNCING"!==t);else{const e=z();M(e)}else{const e=z();C(e)}else{const e=z();F(e)}}]]),R.use((({roomId:e,eventId:t})=>{const n=W().getRoom(e);if(!n)throw new k;const o=n.findEventById(t);if(!o)throw new U;return W().setRoomReadMarkers(e,t,o)})),u.use((()=>W().stopClient())),y.use((async({roomId:e,initialEventId:t,initialWindowSize:n})=>{const o=W(),r=W().getRoom(e);if(!r)throw new k;const i=r.getUnfilteredTimelineSet();return G=new s.default.TimelineWindow(o,i),await G.load(t,n),G.getEvents().filter((e=>[A,N].includes(e.getType()))).reduce(j,[])})),E.use((async({initialEventId:e,initialWindowSize:t})=>{if(!G)throw new q;return await G.load(e,t),G.getEvents().filter((e=>[A,N].includes(e.getType()))).reduce(j,[])})),w.use((()=>G?G.getEvents().filter((e=>[A,N].includes(e.getType()))).reduce(j,[]):[])),I.use((async({direction:e,size:t,makeRequest:n,requestLimit:o})=>{if(!G)throw new q;const r="forward"===e?s.default.EventTimeline.FORWARDS:s.default.EventTimeline.BACKWARDS;if(!await G.paginate(r,t,n,o))throw new O;return G.getEvents().filter((e=>[A,N].includes(e.getType()))).reduce(j,[])})),Object.defineProperty(exports,"MatrixEvent",{enumerable:!0,get:function(){return e.MatrixEvent}}),Object.defineProperty(exports,"Room",{enumerable:!0,get:function(){return e.Room}}),Object.defineProperty(exports,"RoomMember",{enumerable:!0,get:function(){return e.RoomMember}}),exports.client=W,exports.deleteMessageFx=x,exports.editMessageFx=p,exports.getRoomTimelineFx=v,exports.getTimelineWindowMessagesFx=w,exports.initStoreFx=c,exports.initTimelineWindowFx=y,exports.loadTimelineWindowFx=E,exports.loginByPasswordFx=a,exports.loginByTokenFx=d,exports.onCachedState=F,exports.onClientEvent=_,exports.onInitialSync=C,exports.onSync=M,exports.paginateTimelineWindowFx=I,exports.prependClientParams=e=>{S=e},exports.readAllMessages=R,exports.roomMessage=T,exports.roomMessageBatch=h,exports.searchFx=f,exports.searchMessageTextFx=m,exports.sendMessageFx=g,exports.startClientFx=l,exports.stopClientFx=u;
//# sourceMappingURL=matrix-effector.cjs.js.map
