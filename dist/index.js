import{throttle as e}from"patronum/throttle";import{createDomain as t,combine as o,attach as n,guard as r,sample as i,forward as a}from"effector";import s,{MatrixEvent as c,EventStatus as d}from"matrix-js-sdk";export{MatrixEvent,Room,RoomMember}from"matrix-js-sdk";import{batchEvents as l}from"@42px/effector-extra";import{debounce as m}from"patronum/debounce";import{createCustomError as u}from"@42px/custom-errors";const f=t("root"),v=f.domain("app"),g=v.event(),p=v.event(),w=v.event(),I=t=>e({source:w,timeout:t}),y=v.effect(),h=v.effect(),R=v.effect(),b=v.effect(),D=v.effect(),A=v.effect(),E=v.effect(),U=f.domain("notification"),k=U.effect(),P=U.effect(),S=U.effect(),C=U.effect(),_=f.domain("room"),M=50,B=50,N=50,W=0,T=50,L=50,x=_.store(null),F=_.store(!1),z=_.store(null),K=_.store(null),O=_.event(),j=_.store(null),H=_.store(0),G=_.store(50),Y=_.store(50),q=_.store(50),$=_.store(0),J=_.store(50),V=_.store(50),Q=o(H,G,((e,t)=>e>=t)),X=o(H,Y,((e,t)=>e>=t)),Z=o(H,q,((e,t)=>e>=t)),ee=o(H,$,((e,t)=>e>=t)),te=o(H,J,((e,t)=>e>=t)),oe=o(H,V,((e,t)=>e>=t)),ne=_.event(),re=_.event(),ie=_.event(),ae=_.event(),se=_.event(),ce=_.event(),de=_.event(),le=_.event(),me=_.event(),ue=_.event(),fe=_.effect(),ve=_.effect(),ge=_.effect(),pe=_.effect(),we=_.effect(),Ie=_.effect(),ye=_.effect(),he=_.effect(),Re=_.effect(),be=_.effect();var De,Ae;!function(e){e.public="public",e.private="private"}(De||(De={})),function(e){e.trustedPrivateChat="trusted_private_chat",e.privateChat="private_chat",e.publicChat="public_chat"}(Ae||(Ae={}));const Ee=f.domain("messages"),Ue=Ee.store([]),ke=Ee.event(),Pe=Ee.event(),Se=Ee.event(),Ce=Ee.effect(),_e=Ee.effect(),Me=Ee.effect(),Be=Ee.effect(),Ne=Ee.effect(),We=Ee.effect(),Te=Ee.effect(),Le=f.domain("pagination"),xe=Le.store(!1),Fe=Le.store(!1),ze=Le.store(!0),Ke=Le.store(!0),Oe=Le.event(),je=Le.event(),He=Le.event(),Ge=Le.event();var Ye;let qe,$e;!function(e){e.Audio="m.audio",e.BadEncrypted="m.bad.encrypted",e.Emote="m.emote",e.File="m.file",e.Image="m.image",e.Notice="m.notice",e.Text="m.text",e.Video="m.video",e.Location="m.location"}(Ye||(Ye={}));let Je=500;const Ve=[],Qe=()=>{qe&&(qe.removeAllListeners(),qe=null),qe=s.createClient($e),Ve.forEach((([e,t])=>{qe.on(e,t)}))},Xe=()=>(qe||Qe(),qe),Ze=e=>{if("string"==typeof e)return void($e=e);const{messageBatchInterval:t,...o}=e;$e=o,void 0!==t&&(Je=t)},et=e=>{Ve.push(...e)},tt=()=>l(ke,Je),ot="m.room.message",nt="m.room.redaction",rt=o(K,j,((e,t)=>Boolean(e)&&Boolean(t))),it=_.event(),at=_.event(),st=_.event(),ct=_.effect(),dt=_.effect(),lt=_.effect(),mt=_.effect(),ut=_.effect(),ft=Le.effect(),vt=n({source:[K,j],effect:ft,mapParams:(e,[t,o])=>({roomId:t,timelineWindow:o,direction:"backward",...e})}),gt=n({source:[K,j],effect:ft,mapParams:(e,[t,o])=>({roomId:t,timelineWindow:o,direction:"forward",...e})}),pt=Ee.event(),wt=Ee.effect(),It=r({source:i(K,[dt.done,ft.done,wt.done],((e,{params:{roomId:t},result:o})=>({currentRoomId:e,roomId:t,...o}))),filter:({currentRoomId:e,roomId:t})=>e===t});function yt(){return Xe().getRooms().map(Wt)}a({from:y.done.map((()=>({initialSyncLimit:20}))),to:b}),et([["Room.timeline",(e,t,o,n,r)=>{const i=e.getType();i!==ot&&i!==nt||!o&&r.liveEvent&&ke(Nt(e))}],["Room",e=>{var t,o;const n=Xe(),r=e.getMember(n.getUserId());if(r&&"invite"!==r.membership)return;(null===(o=null===(t=e.currentState.getStateEvents("m.room.create",void 0)[0])||void 0===t?void 0:t.getContent())||void 0===o?void 0:o.isDirect)?me(e):ue(e)}],["Room.localEchoUpdated",()=>pt()],["sync",(e,t)=>{if("PREPARED"!==e)if("SYNCING"!==e||"PREPARED"!==t)if("SYNCING"!==e||"SYNCING"!==t);else{const e=yt();w(e)}else{const e=yt();g(e)}else{const e=yt();p(e)}}],["RoomState.members",(e,t,o)=>at(o)],["RoomState.newMember",(e,t,o)=>at(o)],["RoomMember.membership",(e,t)=>at(t)],["RoomMember.name",(e,t)=>at(t)],["RoomMember.powerLevel",(e,t)=>at(t)],["RoomMember.typing",(e,t)=>at(t)],["User.avatarUrl",(e,t)=>it(t)],["User.presence",(e,t)=>it(t)],["User.displayName",(e,t)=>it(t)]]),y.use((e=>Xe().login("m.login.password",e))),h.use((e=>Xe().login("m.login.token",e))),R.use((async()=>{const{store:e}=Xe();if(e)return e.startup()})),b.use((e=>Xe().startClient(e))),E.use((()=>Xe().logout())),A.use((()=>Xe().stopClient())),D.use((async()=>{const e=Xe();if(!e)return null;const t=e.getUserId();if(!t)return null;const o=e.getUser(t);if(!o)return null;const n=Lt(o);if(!n.avatarUrl||!n.displayName){const o=await e.getProfileInfo(t);n.avatarUrl=o.avatar_url,n.displayName=o.displayname}return n})),k.use((()=>Xe().getPushRules())),P.use((async e=>{try{await Xe().setPushRuleActions(e.scope,e.kind,e.ruleId,e.actions)}catch(e){throw console.error("Error while setNotificationRuleAction.Fx"),console.error(e),e}})),S.use((async e=>{try{console.error("Getting push rules...");const t=await Xe().getPushRules();console.error(t.global.room),await Xe().setPushRuleEnabled(e.scope,e.kind,e.ruleId,e.enabled)}catch(e){console.error("Error while setNotificationRuleEnabled"),console.error(e)}})),C.use((async e=>{await Xe().deletePushRule(e.scope,e.kind,e.ruleId)}));const ht=u("EventNotFound"),Rt=u("RoomNotFound"),bt=u("ClientNotInitialized"),Dt=u("TimelineWindowUndefined"),At=u("UserNotFound"),Et=u("UserNotLoggedIn"),Ut=n({effect:dt}),kt=n({effect:dt}),Pt=n({effect:dt}),St=m({source:st,timeout:500});K.on(ne,((e,{roomId:t})=>t)).reset(O),j.on(ct.doneData,((e,t)=>t)).reset(K),z.on(lt.doneData,((e,t)=>t)).reset(K),H.on(mt.doneData,((e,t)=>t)).reset(K),G.on(ut.doneData,((e,t)=>t.kick)).reset(K),q.on(ut.doneData,((e,t)=>t.ban)).reset(K),Y.on(ut.doneData,((e,t)=>t.invite)).reset(K),$.on(ut.doneData,((e,t)=>t.defaultEvents)).reset(K),J.on(ut.doneData,((e,t)=>t.redact)).reset(K),V.on(ut.doneData,((e,t)=>t.stateDefault)).reset(K),a({from:dt.pending,to:F}),a({from:ne,to:ct}),a({from:Ut.done,to:re}),a({from:i({source:j,clock:ct.done,fn:()=>{}}),to:ie}),a({from:kt.done,to:ae}),a({from:Pt.done,to:se}),r({source:K,filter:e=>Boolean(e),target:st}),r({clock:it,source:z,filter:(e,t)=>Boolean(null==e?void 0:e.find((e=>e.userId===t.userId))),target:st}),r({clock:at,source:K,filter:(e,t)=>e===t.roomId,target:st}),r({source:K,clock:St,filter:Boolean,target:lt}),r({source:i([K,j],ce,(([e,t],{initialEventId:o,initialWindowSize:n,loadAdditionalDataDirection:r="BACKWARD"})=>({roomId:e,timelineWindow:t,initialEventId:o,initialWindowSize:n,loadAdditionalDataDirection:r}))),filter:rt,target:Pt}),r({source:i([K,j],le,(([e,t],{initialEventId:o,initialWindowSize:n})=>({roomId:e,timelineWindow:t,initialEventId:o,initialWindowSize:n,loadAdditionalDataDirection:"BACKWARD"}))),filter:rt,target:kt}),r({source:i([K,j],de,(([e,t])=>({roomId:e,timelineWindow:t,loadAdditionalDataDirection:"BACKWARD"}))),filter:rt,target:Ut}),r({clock:K,filter:Boolean,target:[mt,ut]}),mt.use((e=>{const t=Xe(),o=t.getRoom(e),n=t.getUserId();if(!n)throw new At;const r=o.getMember(n);if(!r)throw new At;return r.powerLevel})),ut.use((e=>{var t,o,n,r,i,a;const s=Xe().getRoom(e).currentState.getStateEvents("m.room.power_levels","")[0].getContent();return{kick:null!==(t=s.kick)&&void 0!==t?t:50,ban:null!==(o=s.ban)&&void 0!==o?o:50,invite:null!==(n=s.invite)&&void 0!==n?n:50,defaultEvents:null!==(r=s.events_default)&&void 0!==r?r:0,stateDefault:null!==(i=s.state_default)&&void 0!==i?i:50,redact:null!==(a=s.redact)&&void 0!==a?a:50}})),lt.use((e=>{const t=Xe().getRoom(e);if(!t)throw new Rt;return Object.values(t.currentState.members).map((e=>{const t=Xe().getUser(e.userId);if(!t)throw new At;return function(e,t){return{membership:e.membership,name:e.name,powerLevel:e.powerLevel,powerLevelNorm:e.powerLevelNorm,rawDisplayName:e.rawDisplayName,roomId:e.roomId,typing:e.typing,user:Lt(t),userId:e.userId}}(e,t)}))})),ge.use((e=>{const t=Xe().getRoom(e);if(!t)throw new Rt;return function(e){return{roomMembersCount:e.getJoinedMemberCount()}}(t)})),ct.use((async({roomId:e})=>{const t=Xe(),o=Xe().getRoom(e);if(!o)throw new Rt;const n=o.getUnfilteredTimelineSet();return new s.TimelineWindow(t,n)})),dt.use((async({timelineWindow:e,initialEventId:t,initialWindowSize:o,loadAdditionalDataDirection:n})=>{if(!e)throw new Dt;await e.load(t,o);const r=e.canPaginate("f");let i=Ft(e);if(o&&i.length<o){let t;const r=o-i.length;t="BACKWARD"===n?await e.paginate(s.EventTimeline.BACKWARDS,r):await e.paginate(s.EventTimeline.FORWARDS,r),t&&(i=Ft(e))}return{messages:i,isLive:!r,canPaginateForward:r,canPaginateBackward:e.canPaginate("b")}})),ve.use((e=>{if(!Xe())throw new bt;return e.map((e=>xt(e,99)))})),fe.use((async({term:e,roomId:t,orderBy:o="rank"})=>{const n=Xe().getRoom(t);if(!n)throw new Rt;const r={};return(await Xe().search({body:{search_categories:{room_events:{search_term:e,keys:["content.body"],filter:{rooms:[t]},order_by:o}}}})).search_categories.room_events.results.map((({result:e})=>{const t=new c(e),o=t.getSender();return void 0===r[o]&&(r[o]=n.getMember(o)),t.sender=r[o],Nt(t)}))})),pe.use((()=>Xe().getUsers().map(Lt))),we.use((async({name:e,invite:t,visibility:o,initialState:n=[],preset:r})=>{const i={name:e,invite:t,visibility:o,initial_state:n.map((e=>({...e,state_key:e.stateKey,stateKey:void 0}))),preset:r},{room_id:a}=await Xe().createRoom(i);return{roomId:a}})),Ie.use((async({user:e,preset:t,initialState:o=[]})=>{const n=Xe(),r=Ot().find((t=>{var o;return null===(o=n.getRoom(t))||void 0===o?void 0:o.currentState.members[e.userId]}));if(r)return{roomId:r};const i={is_direct:!0,invite:[e.userId],visibility:De.private,initial_state:o.map((e=>({...e,state_key:e.stateKey,stateKey:void 0}))),preset:t,creation_content:{isDirect:!0,creator:n.getUserId()}},{room_id:a}=await n.createRoom(i);return await Yt(a),{roomId:a}})),ye.use((async({userId:e,roomId:t})=>{await Xe().invite(t,e)})),he.use((async({roomId:e,userId:t,reason:o})=>{await Xe().kick(e,t,o)})),Re.use((async({roomId:e,name:t})=>{await Xe().setRoomName(e,t)})),be.use((async({roomId:e,isDirect:t=!1})=>{const o=Xe(),n=await o.joinRoom(e);return t&&await Yt(e),xt(Wt(n),99)}));const Ct=tt(),_t=n({effect:gt,mapParams:({messages:e})=>({size:e.length})});Ue.on(It,((e,{messages:t})=>t)).reset(K),x.on(It,((e,{isLive:t})=>t)).reset(K),a({from:i(Ue,_t.done,((e,{params:t})=>t.messages)),to:Pe}),a({from:Ct.map((e=>({messages:e}))),to:_t}),r({source:i([K,j],pt,(([e,t])=>({timelineWindow:t,roomId:e}))),filter:j.map((e=>Boolean(e))),target:wt}),Ce.use((({roomId:e,content:t,txnId:o})=>Xe().sendMessage(e,t,o))),_e.use((({roomId:e,eventId:t,body:o,txnId:n})=>Xe().sendMessage(e,{"m.new_content":{msgtype:"m.text",body:o},"m.relates_to":{rel_type:"m.replace",event_id:t},msgtype:"m.text",body:""},n))),Me.use((async({roomId:e,eventId:t,reason:o})=>{const n=o?{reason:o}:void 0;return{eventId:(await Xe().redactEvent(e,t,void 0,n)).event_id}})),Be.use((({roomId:e,eventId:t})=>{const o=Xe().getRoom(e);if(!o)throw new Rt;const n=o.findEventById(t);if(!n)throw new ht;return Xe().setRoomReadMarkers(e,t,n)})),We.use((({file:e,name:t,includeFilename:o,onlyContentUri:n,rawResponse:r,type:i})=>{const a=Xe().uploadContent(e,{name:t,includeFilename:o,type:i,onlyContentUri:n,rawResponse:r,progressHandler:({loaded:t,total:o})=>{Se({file:e,loaded:t,total:o})}}),s={promise:a};return a.abort&&(s.abort=a.abort),s})),Te.use((({url:e,ts:t,timeout:o=5e3})=>new Promise((n=>{Xe().getUrlPreview(e,t).then(n).catch((()=>n({"og:url":e}))),setTimeout((()=>{n({"og:url":e})}),o)})))),Ne.use((({eventId:e,roomId:t})=>{const o=Xe();if(!o)throw new bt;const n=o.getRoom(t);if(!n)throw new Rt;const r=n.findEventById(e);if(!r)throw new ht;const i=o.getUserId();if(!i)throw new Et;return{canRedact:n.currentState.maySendRedactionForEvent(r,i)&&"m.room.server_acl"!==r.getType(),canEdit:function(e){if(e.status===d.CANCELLED||"m.room.message"!==e.getType()||e.isRedacted())return!1;const t=e.getOriginalContent(),{msgtype:o}=t;return("m.text"===o||"m.emote"===o)&&Boolean(t.body)&&"string"==typeof t.body&&e.getSender()===Xe().getUserId()}(r)}})),wt.use((({timelineWindow:e})=>{const t=e.canPaginate("f");return{messages:Ft(e),isLive:!t,canPaginateForward:t,canPaginateBackward:e.canPaginate("b")}}));const Mt=o(rt,Fe,xe,F,((e,t,o,n)=>e&&!t&&!o&&!n));function Bt(e){return{...e.getContent()}}function Nt(e,t){var o;const n=e.getRelation();return{originalEventId:void 0!==t?t:e.getId(),content:Bt(e),sender:e.sender,originServerTs:e.getDate(),edited:"m.replace"===(null===(o=n)||void 0===o?void 0:o.rel_type),redacted:e.isRedacted()||e.isRedaction()}}function Wt(e){return{roomId:e.roomId,name:e.name,summary:e.summary,myMembership:e.getMyMembership()}}function Tt(e,t){return t.isRelation("m.replace")||t.isRedaction()||e.push(Nt(t)),e}Fe.on(vt.pending,((e,t)=>t)).reset(K),xe.on(gt.pending,((e,t)=>t)).reset(K),ze.on(It,((e,{canPaginateBackward:t})=>t)).reset([ce,K]),Ke.on(It,((e,{canPaginateForward:t})=>t)).reset([ce,K]),a({from:vt.done,to:Oe}),a({from:gt.done,to:je}),r({source:Ge,filter:Mt,target:vt}),r({source:He,filter:Mt,target:gt}),ft.use((async({timelineWindow:e,direction:t,size:o,makeRequest:n,requestLimit:r})=>{if(!e)throw new Dt;const i="forward"===t?s.EventTimeline.FORWARDS:s.EventTimeline.BACKWARDS;await e.paginate(i,o,n,r);const a=e.canPaginate("f");return{messages:Ft(e),isLive:!a,canPaginateForward:a,canPaginateBackward:e.canPaginate("b")}}));const Lt=e=>({avatarUrl:e.avatarUrl,userId:e.userId,currentlyActive:e.currentlyActive,displayName:e.displayName,lastActiveAgo:e.lastActiveAgo,lastPresenceTs:e.lastPresenceTs,presence:e.presence});function xt(e,t){var o;const n=Xe(),r=n.getRoom(e.roomId);if(!r)throw new Rt;const i=r.getLiveTimeline().getEvents();let a=0;for(let e=i.length-1;e>=0&&e!==i.length-t;e--){const t=i[e];if(r.hasUserReadEvent(n.getUserId(),t.getId()))break;a+=1}const s=i.filter((e=>[ot,nt].includes(e.getType()))).reduce(Tt,[]),c=s.length?s[s.length-1]:void 0,d=Ht(e.roomId),l=d?r.getMember(r.guessDMUserId()):null;return{...e,unreadCount:a,lastMessage:c,isDirect:d,directUserId:null==l?void 0:l.userId,isOnline:l?Boolean(null===(o=l.user)||void 0===o?void 0:o.currentlyActive):void 0,lastActivityTS:r.getLastActiveTimestamp()}}function Ft(e){return e.getEvents().filter((e=>[ot,nt].includes(e.getType()))).reduce(Tt,[])}const zt=({sender:e,width:t,height:o,resizeMethod:n,allowDefault:r=!0,allowDirectLinks:i=!1})=>e&&e.getAvatarUrl?e.getAvatarUrl(Xe().getHomeserverUrl(),t,o,n,r,i):null,Kt=({roomId:e,userId:t,width:o,height:n,resizeMethod:r,allowDefault:i=!0})=>{const a=Xe().getRoom(e);if(!a)return null;const s=a.getMember(t);return s?s.getAvatarUrl(Xe().getHomeserverUrl(),o,n,r,i,!0):null},Ot=()=>{var e;const t=null===(e=Xe().getAccountData("m.direct"))||void 0===e?void 0:e.getContent();return t&&Object.values(t).flatMap((e=>e))},jt=({mxcUrl:e,width:t,height:o,resizeMethod:n,allowDirectLinks:r})=>Xe().mxcUrlToHttp(e,void 0!==t?t:null,void 0!==o?o:null,void 0!==n?n:"scale",void 0!==r?r:null),Ht=e=>Ot().includes(e),Gt=()=>({endpointUrl:`${Xe().getHomeserverUrl()}/_matrix/media/r0/upload`,headers:{Authorization:`Bearer ${Xe().getAccessToken()}`}}),Yt=e=>{var t,o,n;const r=Xe(),{creator:i}=null===(o=(null===(t=r.getRoom(e))||void 0===t?void 0:t.currentState.getStateEvents("m.room.create",void 0))[0])||void 0===o?void 0:o.getContent(),a=null===(n=r.getAccountData("m.direct"))||void 0===n?void 0:n.getContent();return r.setAccountData("m.direct",{...a,[i]:[e]})};export{Z as $canBan,X as $canInvite,Q as $canKick,ze as $canPaginateBackward,Ke as $canPaginateForward,te as $canRedact,ee as $canSendDefaultEvent,oe as $canSetDefaultState,K as $currentRoomId,z as $currentRoomMembers,x as $isLive,F as $loadRoomFxPending,Ue as $messages,H as $myPowerLevel,Fe as $paginateBackwardPending,xe as $paginateForwardPending,q as $requiredPowerLevelForBan,$ as $requiredPowerLevelForDefaultEvents,V as $requiredPowerLevelForDefaultState,Y as $requiredPowerLevelForInvite,G as $requiredPowerLevelForKick,J as $requiredPowerLevelForRedact,j as $timelineWindow,B as DEFAULT_BAN_POWERLEVEL,M as DEFAULT_INVITE_POWERLEVEL,N as DEFAULT_KICK_POWERLEVEL,L as DEFAULT_REDACT_POWERLEVEL,W as DEFAULT_SEND_DEFAULT_EVENT_POWERLEVEL,T as DEFAULT_SET_DEFAULT_STATE_POWERLEVEL,Ye as MsgType,Ae as Preset,De as Visibility,Ne as checkEventPermissionsFx,Ht as checkIsDirect,O as clearCurrentRoomState,Xe as client,Qe as createClient,Ie as createDirectRoomFx,I as createOnSyncThrottled,we as createRoomFx,tt as createRoomMessageBatch,Me as deleteMessageFx,C as deleteNotificationRuleFx,me as directRoomCreated,_e as editMessageFx,pe as getAllUsersFx,D as getLoggedUserFx,k as getNotificationRulesFx,ge as getRoomInfoFx,Kt as getRoomMemberAvatarUrl,ve as getRoomsWithActivitiesFx,zt as getSenderAvatarUrl,Gt as getUploadCredentials,Te as getUrlPreviewFx,ne as initRoom,R as initStoreFx,ye as inviteUserFx,be as joinRoomFx,he as kickUserRoomFx,re as liveTimelineLoaded,ce as loadRoom,le as loadRoomMessage,ae as loadRoomMessageDone,y as loginByPasswordFx,h as loginByTokenFx,E as logoutFx,jt as mxcUrlToHttp,Pe as newMessagesLoaded,p as onCachedState,et as onClientEvent,g as onInitialSync,Oe as onPaginateBackwardDone,je as onPaginateForwardDone,ie as onRoomInitialized,se as onRoomLoaded,w as onSync,Se as onUploadProgress,Ge as paginateBackward,He as paginateForward,Ze as prependClientParams,Be as readAllMessagesFx,Re as renameRoomFx,ue as roomCreated,ke as roomMessage,fe as searchRoomMessagesFx,Ce as sendMessageFx,P as setNotificationRuleActionFx,S as setNotificationRuleEnabledFx,b as startClientFx,A as stopClientFx,de as toLiveTimeline,We as uploadContentFx};
//# sourceMappingURL=index.js.map
