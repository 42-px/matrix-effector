import{throttle as e}from"patronum/throttle";import{createDomain as t,combine as o,attach as n,guard as r,sample as i,forward as a}from"effector";import s,{MatrixEvent as l,EventStatus as c}from"matrix-js-sdk";export{MatrixEvent,Room,RoomMember}from"matrix-js-sdk";import{batchEvents as d}from"@42px/effector-extra";import{debounce as m}from"patronum/debounce";import{createCustomError as u}from"@42px/custom-errors";const f=t("root"),g=f.domain("app"),v=g.event(),p=g.event(),w=g.event(),I=t=>e({source:w,timeout:t}),y=g.effect(),h=g.effect(),R=g.effect(),A=g.effect(),b=g.effect(),E=g.effect(),U=g.effect(),D=f.domain("notification"),P=D.effect(),N=D.effect(),B=D.effect(),C=D.effect(),T=f.domain("room"),W=T.store(null),k=T.store(!1),S=T.store(null),L=T.store(null),M=T.store(null),x=T.event(),_=T.event(),F=T.event(),z=T.event(),K=T.event(),O=T.event(),H=T.event(),j=T.effect(),G=T.effect(),Y=T.effect(),q=f.domain("messages"),$=q.store([]),J=q.event(),V=q.event(),Q=q.event(),X=q.effect(),Z=q.effect(),ee=q.effect(),te=q.effect(),oe=q.effect(),ne=q.effect(),re=q.effect(),ie=f.domain("pagination"),ae=ie.store(!1),se=ie.store(!1),le=ie.store(!0),ce=ie.store(!0),de=ie.event(),me=ie.event(),ue=ie.event();var fe;let ge,ve;!function(e){e.Audio="m.audio",e.BadEncrypted="m.bad.encrypted",e.Emote="m.emote",e.File="m.file",e.Image="m.image",e.Notice="m.notice",e.Text="m.text",e.Video="m.video",e.Location="m.location"}(fe||(fe={}));let pe=500;const we=[],Ie=()=>{ge&&(ge.removeAllListeners(),ge=null),ge=s.createClient(ve),we.forEach((([e,t])=>{ge.on(e,t)}))},ye=()=>(ge||Ie(),ge),he=e=>{if("string"==typeof e)return void(ve=e);const{messageBatchInterval:t,...o}=e;ve=o,void 0!==t&&(pe=t)},Re=e=>{we.push(...e)},Ae=()=>d(J,pe),be="m.room.message",Ee="m.room.redaction";function Ue(e){return{...e.getContent()}}function De(e,t){var o;const n=e.getRelation();return{originalEventId:void 0!==t?t:e.getId(),content:Ue(e),sender:e.sender,originServerTs:e.getDate(),edited:"m.replace"===(null===(o=n)||void 0===o?void 0:o.rel_type),redacted:e.isRedacted()||e.isRedaction()}}function Pe(e){return{roomId:e.roomId,name:e.name,summary:e.summary}}function Ne(e,t){return t.isRelation("m.replace")||t.isRedaction()||e.push(De(t)),e}function Be(e){return e.getEvents().filter((e=>[be,Ee].includes(e.getType()))).reduce(Ne,[])}const Ce=({sender:e,width:t,height:o,resizeMethod:n,allowDefault:r=!0,allowDirectLinks:i=!1})=>e&&e.getAvatarUrl?e.getAvatarUrl(ye().getHomeserverUrl(),t,o,n,r,i):null,Te=({roomId:e,userId:t,width:o,height:n,resizeMethod:r,allowDefault:i=!0})=>{const a=ye().getRoom(e);if(!a)return null;const s=a.getMember(t);return s?s.getAvatarUrl(ye().getHomeserverUrl(),o,n,r,i,!0):null},We=({mxcUrl:e,width:t,height:o,resizeMethod:n,allowDirectLinks:r})=>ye().mxcUrlToHttp(e,void 0!==t?t:null,void 0!==o?o:null,void 0!==n?n:"scale",void 0!==r?r:null),ke=e=>{const t=ye().getAccountData("m.direct"),o=t?Object.values(t.getContent()):[];let n=[];for(const e of o)n=[...n,...e];return!!n.includes(e)},Se=()=>({endpointUrl:`${ye().getHomeserverUrl()}/_matrix/media/r0/upload`,headers:{Authorization:`Bearer ${ye().getAccessToken()}`}}),Le=o(L,M,((e,t)=>Boolean(e)&&Boolean(t))),Me=T.event(),xe=T.event(),_e=T.event(),Fe=T.effect(),ze=T.effect(),Ke=T.effect(),Oe=ie.effect(),He=n({source:[L,M],effect:Oe,mapParams:(e,[t,o])=>({roomId:t,timelineWindow:o,direction:"backward",...e})}),je=n({source:[L,M],effect:Oe,mapParams:(e,[t,o])=>({roomId:t,timelineWindow:o,direction:"forward",...e})}),Ge=q.event(),Ye=q.effect(),qe=r({source:i(L,[ze.done,Oe.done,Ye.done],((e,{params:{roomId:t},result:o})=>({currentRoomId:e,roomId:t,...o}))),filter:({currentRoomId:e,roomId:t})=>e===t});function $e(){return ye().getRooms().map(Pe)}a({from:y.done.map((()=>({initialSyncLimit:20}))),to:A}),Re([["Room.timeline",(e,t,o,n,r)=>{const i=e.getType();i!==be&&i!==Ee||!o&&r.liveEvent&&J(De(e))}],["Room.localEchoUpdated",()=>Ge()],["sync",(e,t)=>{if("PREPARED"!==e)if("SYNCING"!==e||"PREPARED"!==t)if("SYNCING"!==e||"SYNCING"!==t);else{const e=$e();w(e)}else{const e=$e();v(e)}else{const e=$e();p(e)}}],["RoomState.members",(e,t,o)=>xe(o)],["RoomState.newMember",(e,t,o)=>xe(o)],["RoomMember.membership",(e,t)=>xe(t)],["RoomMember.name",(e,t)=>xe(t)],["RoomMember.powerLevel",(e,t)=>xe(t)],["RoomMember.typing",(e,t)=>xe(t)],["User.avatarUrl",(e,t)=>Me(t)],["User.presence",(e,t)=>Me(t)],["User.displayName",(e,t)=>Me(t)]]),y.use((e=>ye().login("m.login.password",e))),h.use((e=>ye().login("m.login.token",e))),R.use((async()=>{const{store:e}=ye();if(e)return e.startup()})),A.use((e=>ye().startClient(e))),U.use((()=>ye().logout())),E.use((()=>ye().stopClient())),b.use((async()=>{const e=ye();if(!e)return null;const t=e.getUserId();if(!t)return null;const o=e.getUser(t);if(!o)return null;let n=o.avatarUrl,r=o.displayName;if(!(null==o?void 0:o.avatarUrl)||!(null==o?void 0:o.displayName)){const o=await e.getProfileInfo(t);n=o.avatar_url,r=o.displayname}return{avatarUrl:n,userId:o.userId,currentlyActive:o.currentlyActive,displayName:r,lastActiveAgo:o.lastActiveAgo,lastPresenceTs:o.lastPresenceTs,presence:o.presence}})),P.use((()=>ye().getPushRules())),N.use((async e=>{try{await ye().setPushRuleActions(e.scope,e.kind,e.ruleId,e.actions)}catch(e){throw console.error("Error while setNotificationRuleAction.Fx"),console.error(e),e}})),B.use((async e=>{try{console.error("Getting push rules...");const t=await ye().getPushRules();console.error(t.global.room),await ye().setPushRuleEnabled(e.scope,e.kind,e.ruleId,e.enabled)}catch(e){console.error("Error while setNotificationRuleEnabled"),console.error(e)}})),C.use((async e=>{await ye().deletePushRule(e.scope,e.kind,e.ruleId)}));const Je=u("EventNotFound"),Ve=u("RoomNotFound"),Qe=u("ClientNotInitialized"),Xe=u("TimelineWindowUndefined"),Ze=u("UserNotFound"),et=u("UserNotLoggedIn"),tt=n({effect:ze}),ot=n({effect:ze}),nt=m({source:_e,timeout:500});L.on(x,((e,{roomId:t})=>t)),M.on(Fe.doneData,((e,t)=>t)).reset(L),S.on(Ke.doneData,((e,t)=>t)).reset(L),a({from:ze.pending,to:k}),a({from:x,to:Fe}),a({from:tt.done,to:_}),a({from:i({source:M,clock:Fe.done,fn:()=>{}}),to:F}),a({from:ot.done,to:z}),r({source:L,filter:e=>Boolean(e),target:_e}),r({clock:Me,source:S,filter:(e,t)=>Boolean(null==e?void 0:e.find((e=>e.userId===t.userId))),target:_e}),r({clock:xe,source:L,filter:(e,t)=>e===t.roomId,target:_e}),r({source:L,clock:nt,filter:Boolean,target:Ke}),r({source:i([L,M],K,(([e,t],{initialEventId:o,initialWindowSize:n,loadAdditionalDataDirection:r="BACKWARD"})=>({roomId:e,timelineWindow:t,initialEventId:o,initialWindowSize:n,loadAdditionalDataDirection:r}))),filter:Le,target:ze}),r({source:i([L,M],H,(([e,t],{initialEventId:o,initialWindowSize:n})=>({roomId:e,timelineWindow:t,initialEventId:o,initialWindowSize:n,loadAdditionalDataDirection:"BACKWARD"}))),filter:Le,target:ot}),r({source:i([L,M],O,(([e,t])=>({roomId:e,timelineWindow:t,loadAdditionalDataDirection:"BACKWARD"}))),filter:Le,target:tt}),Ke.use((e=>{const t=ye().getRoom(e);if(!t)throw new Ve;return Object.values(t.currentState.members).map((e=>{const t=ye().getUser(e.userId);if(!t)throw new Ze;return function(e,t){return{membership:e.membership,name:e.name,powerLevel:e.powerLevel,powerLevelNorm:e.powerLevelNorm,rawDisplayName:e.rawDisplayName,roomId:e.roomId,typing:e.typing,user:{avatarUrl:t.avatarUrl,userId:t.userId,currentlyActive:t.currentlyActive,displayName:t.displayName,lastActiveAgo:t.lastActiveAgo,lastPresenceTs:t.lastPresenceTs,presence:t.presence},userId:e.userId}}(e,t)}))})),Y.use((e=>{const t=ye().getRoom(e);if(!t)throw new Ve;return function(e){return{roomMembersCount:e.getJoinedMemberCount()}}(t)})),Fe.use((async({roomId:e})=>{const t=ye(),o=ye().getRoom(e);if(!o)throw new Ve;const n=o.getUnfilteredTimelineSet();return new s.TimelineWindow(t,n)})),ze.use((async({timelineWindow:e,initialEventId:t,initialWindowSize:o,loadAdditionalDataDirection:n})=>{if(!e)throw new Xe;await e.load(t,o);const r=e.canPaginate("f");let i=Be(e);if(o&&i.length<o){let t;const r=o-i.length;t="BACKWARD"===n?await e.paginate(s.EventTimeline.BACKWARDS,r):await e.paginate(s.EventTimeline.FORWARDS,r),t&&(i=Be(e))}return{messages:i,isLive:!r,canPaginateForward:r,canPaginateBackward:e.canPaginate("b")}})),G.use((e=>{const t=ye();if(!t)throw new Qe;return e.map((e=>{var o;const n=t.getRoom(e.roomId);if(!n)throw new Ve;const r=n.getLiveTimeline().getEvents();let i=0;for(let e=r.length-1;e>=0&&e!==r.length-99;e--){const o=r[e];if(n.hasUserReadEvent(t.getUserId(),o.getId()))break;i+=1}const a=r.filter((e=>[be,Ee].includes(e.getType()))).reduce(Ne,[]),s=a.length?a[a.length-1]:void 0,l=ke(n.roomId),c=l?n.getMember(n.guessDMUserId()):null;return{...e,unreadCount:i,lastMessage:s,isDirect:l,directUserId:null==c?void 0:c.userId,isOnline:c?Boolean(null===(o=c.user)||void 0===o?void 0:o.currentlyActive):void 0,lastActivityTS:n.getLastActiveTimestamp()}}))})),j.use((async({term:e,roomId:t,orderBy:o="rank"})=>{const n=ye().getRoom(t);if(!n)throw new Ve;const r={};return(await ye().search({body:{search_categories:{room_events:{search_term:e,keys:["content.body"],filter:{rooms:[t]},order_by:o}}}})).search_categories.room_events.results.map((({result:e})=>{const t=new l(e),o=t.getSender();return void 0===r[o]&&(r[o]=n.getMember(o)),t.sender=r[o],De(t)}))}));const rt=Ae(),it=n({effect:je,mapParams:({messages:e})=>({size:e.length})});$.on(qe,((e,{messages:t})=>t)).reset(L),W.on(qe,((e,{isLive:t})=>t)).reset(L),a({from:i($,it.done,((e,{params:t})=>t.messages)),to:V}),a({from:rt.map((e=>({messages:e}))),to:it}),r({source:i([L,M],Ge,(([e,t])=>({timelineWindow:t,roomId:e}))),filter:M.map((e=>Boolean(e))),target:Ye}),X.use((({roomId:e,content:t,txnId:o})=>ye().sendMessage(e,t,o))),Z.use((({roomId:e,eventId:t,body:o,txnId:n})=>ye().sendMessage(e,{"m.new_content":{msgtype:"m.text",body:o},"m.relates_to":{rel_type:"m.replace",event_id:t},msgtype:"m.text",body:""},n))),ee.use((async({roomId:e,eventId:t,reason:o})=>{const n=o?{reason:o}:void 0;return{eventId:(await ye().redactEvent(e,t,void 0,n)).event_id}})),te.use((({roomId:e,eventId:t})=>{const o=ye().getRoom(e);if(!o)throw new Ve;const n=o.findEventById(t);if(!n)throw new Je;return ye().setRoomReadMarkers(e,t,n)})),ne.use((({file:e,name:t,includeFilename:o,onlyContentUri:n,rawResponse:r,type:i})=>{const a=ye().uploadContent(e,{name:t,includeFilename:o,type:i,onlyContentUri:n,rawResponse:r,progressHandler:({loaded:t,total:o})=>{Q({file:e,loaded:t,total:o})}}),s={promise:a};return a.abort&&(s.abort=a.abort),s})),re.use((({url:e,ts:t,timeout:o=5e3})=>new Promise((n=>{ye().getUrlPreview(e,t).then(n).catch((()=>n({"og:url":e}))),setTimeout((()=>{n({"og:url":e})}),o)})))),oe.use((({eventId:e,roomId:t})=>{const o=ye();if(!o)throw new Qe;const n=o.getRoom(t);if(!n)throw new Ve;const r=n.findEventById(e);if(!r)throw new Je;const i=o.getUserId();if(!i)throw new et;return{canRedact:n.currentState.maySendRedactionForEvent(r,i)&&"m.room.server_acl"!==r.getType(),canEdit:function(e){if(e.status===c.CANCELLED||"m.room.message"!==e.getType()||e.isRedacted())return!1;const t=e.getOriginalContent(),{msgtype:o}=t;return("m.text"===o||"m.emote"===o)&&Boolean(t.body)&&"string"==typeof t.body&&e.getSender()===ye().getUserId()}(r)}})),Ye.use((({timelineWindow:e})=>{const t=e.canPaginate("f");return{messages:Be(e),isLive:!t,canPaginateForward:t,canPaginateBackward:e.canPaginate("b")}}));const at=o(Le,se,ae,k,((e,t,o,n)=>e&&!t&&!o&&!n));se.on(He.pending,((e,t)=>t)).reset(L),ae.on(je.pending,((e,t)=>t)).reset(L),le.on(qe,((e,{canPaginateBackward:t})=>t)).reset([K,L]),ce.on(qe,((e,{canPaginateForward:t})=>t)).reset([K,L]),a({from:He.done,to:de}),r({source:ue,filter:at,target:He}),r({source:me,filter:at,target:je}),Oe.use((async({timelineWindow:e,direction:t,size:o,makeRequest:n,requestLimit:r})=>{if(!e)throw new Xe;const i="forward"===t?s.EventTimeline.FORWARDS:s.EventTimeline.BACKWARDS;await e.paginate(i,o,n,r);const a=e.canPaginate("f");return{messages:Be(e),isLive:!a,canPaginateForward:a,canPaginateBackward:e.canPaginate("b")}}));export{le as $canPaginateBackward,ce as $canPaginateForward,L as $currentRoomId,S as $currentRoomMembers,W as $isLive,k as $loadRoomFxPending,$ as $messages,se as $paginateBackwardPending,ae as $paginateForwardPending,M as $timelineWindow,fe as MsgType,oe as checkEventPermissionsFx,ke as checkIsDirect,ye as client,Ie as createClient,I as createOnSyncThrottled,Ae as createRoomMessageBatch,ee as deleteMessageFx,C as deleteNotificationRuleFx,Z as editMessageFx,b as getLoggedUserFx,Be as getMessages,P as getNotificationRulesFx,Y as getRoomInfoFx,Te as getRoomMemberAvatarUrl,G as getRoomsWithActivitiesFx,Ce as getSenderAvatarUrl,Se as getUploadCredentials,re as getUrlPreviewFx,x as initRoom,R as initStoreFx,_ as liveTimelineLoaded,K as loadRoom,H as loadRoomMessage,z as loadRoomMessageDone,y as loginByPasswordFx,h as loginByTokenFx,U as logoutFx,We as mxcUrlToHttp,V as newMessagesLoaded,p as onCachedState,Re as onClientEvent,v as onInitialSync,de as onPaginateBackwardDone,F as onRoomInitialized,w as onSync,Q as onUploadProgress,ue as paginateBackward,me as paginateForward,he as prependClientParams,te as readAllMessagesFx,J as roomMessage,j as searchRoomMessagesFx,X as sendMessageFx,N as setNotificationRuleActionFx,B as setNotificationRuleEnabledFx,A as startClientFx,E as stopClientFx,O as toLiveTimeline,ne as uploadContentFx};
//# sourceMappingURL=index.js.map
